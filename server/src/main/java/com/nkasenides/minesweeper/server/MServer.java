/* --------------------------------------------------------------------------------
  This file was automatically generated by the Athlos Project Editor.
  Athlos Framework: http://nkasenides.github.io/athlos
  Generated on: 16-11-2021 12:37:22
  Athlos Project Editor, v0.1.0 BETA
-------------------------------------------------------------------------------- */

package com.nkasenides.minesweeper.server;
import com.nkasenides.minesweeper.model.*;
import com.nkasenides.minesweeper.proto.*;
import com.nkasenides.minesweeper.server.grpc.MAServiceImpl;
import com.google.protobuf.GeneratedMessageV3;
import com.nkasenides.athlos.model.IPlayer;
import com.nkasenides.athlos.server.GameServer;
import com.raylabz.objectis.Objectis;
import com.raylabz.objectis.exception.ClassRegistrationException;
import io.grpc.BindableService;
import io.grpc.stub.StreamObserver;
import redis.clients.jedis.JedisPool;

import java.io.IOException;
import java.util.HashSet;
import java.util.LinkedHashSet;

public class MServer extends GameServer<
        MAPartialStateProto, MAGameSession, MAWorldSession,
        MAPlayer, MATeam, MAEntity, MATerrainChunk,
        MATerrainCell, MAWorld> {

    public static final int PORT = 25000;
    public static final MServer instance;
    public static LinkedHashSet<StreamObserver<UpdateStateResponse>> observers = new LinkedHashSet<>();

    static {
        HashSet<BindableService> services = new HashSet<>();
        services.add(new MAServiceImpl());
        instance = new MServer("MServer", PORT, services);
    }
    public MServer(String name, int port, HashSet<BindableService> services) {    
        super(name, port, services);        
    }    

    @Override
    protected void runInBackground() { }

    public static void main(String[] args) {
        try {
            initializeObjectis();
            instance.start();
        } catch (IOException e) {
            e.printStackTrace();
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }

    //NEW
    public static void initializeObjectis() {
        JedisPool jedisPool = new JedisPool("localhost", 6379);
        Objectis.init(jedisPool);
        Objectis.useMultithreading(false);
        try {
            Objectis.register(MAWorld.class);
            Objectis.register(MAWorldSession.class);
            Objectis.register(MAGameSession.class);
            Objectis.register(MAPlayer.class);
            Objectis.register(MATerrainChunk.class);
            Objectis.register(MATerrainCell.class);
        } catch (ClassRegistrationException e) {
            e.printStackTrace();
        }
    }

}
